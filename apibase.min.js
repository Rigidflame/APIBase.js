!function(){"use strict";var e,t;if(e=function(e){var n,r=this;"string"==typeof e&&(r._ref=new t.Firebase(e)),"object"==typeof e&&(r._ref=e),r._attributes=[],r._online=!1,r._authState=0,r._pendingResolutions=[],r._methods={},r._user={},r._isServer=!1,r._cleanUpInterval=6e4,r._context={};for(n in r)r._attributes.push(n);r._ref.child("_meta/online").on("value",function(e){r._online=e.val()?!0:!1})},e.prototype.publish=function(){var e=this._defer(),t=this;t._isServer=!0,this._ref.child("_meta/online").once("value",function(n){if(n.val())throw"A APIBase server is already running at "+t._ref.toString();t._pendingResolutions.push(e.resolve.bind(e)),t._progress()}),e.promise.then(function(){var e,n,r;for(e in t)-1===t._attributes.indexOf(e)&&(t._methods[e]=!0);t._ref.child("_meta/methods").set(t._methods),t._ref.child("_meta/methods").onDisconnect().remove(),t._ref.child("_meta/online").set(!0),t._ref.child("_meta/online").onDisconnect().set(!1);for(n in t._methods)r=t._ref.child("queue").child("request"),r.child(n).on("child_added",t._handleQueueItem.bind(t)),setInterval(t._cleanUp.bind(t,n),t._cleanUpInterval);t._ref.child("queue").child("request").on("child_added",t._handleMethodType.bind(t)),t._ref.child("_meta/online").on("value",function(e){var n=e.val();n&&t._log("APIBase is listening for requests...")})})},e.prototype.get=function(e){return this._createFunction(e)},e.prototype.retrieve=function(){var e={},t=this._defer(),n=this;return this._ref.child("_meta/methods").once("value",function(r){r.forEach(function(t){var r=t.name();e[r]=n._createFunction(r)}),n._pendingResolutions.push(t.resolve.bind(t,e)),n._progress()}),t.promise},e.prototype.auth=function(e,t){var n=this;n._authState=1,n._ref.root().child(".info/authenticated").once("value",function(r){var i=r.val();(!i||t)&&n._ref.auth(e.toString(),function(e,t){if(e)throw e;n._authState=2,n._user=t.auth,n._progress()})})},e.prototype.setUserData=function(e){var t=this;t._ref.root().child(".info/authenticated").once("value",function(n){var r=n.val();if(!r)throw"setUserData should only be called after you've manually authenticated.";t._user=e})},e.prototype.context=function(e){this._context=e},e.prototype._progress=function(){var e;if(2!==this._authState)return!1;for(e=0;e<this._pendingResolutions.length;e+=1)this._pendingResolutions[e]();return this._pendingResolutions=[],!0},e.prototype._handleMethodType=function(e){var t=e.name();this._methods[t]||(this._log('Unknown method "'+t+'" was called. Cleaning up...'),e.ref().remove())},e.prototype._handleQueueItem=function(e){var n,r,i=(e.val(),e.ref().parent().name()),o=e.ref().name(),s=this,a=function(n){u.setWithPriority(n,t.Firebase.ServerValue.TIMESTAMP),e.ref().remove()},u=this._ref.child("queue/response").child(i).child(o),c=e.val().args,l=e.val().ctx,h=e.val().uid,f=[];if(!c)return void s._log("ERROR: Request Queue ticket has malformed or no arguments field.");if(!h)return void s._log("ERROR: Request Queue ticket has no UID field.");for("\\apibase.empty\\"==c&&(c=[]),n=0;n<c.length;n+=1)r=c[n],f.push("\\apibase.undefined\\"==r?void 0:"\\apibase.null\\"==r?null:r);this._apply(i,f,l).then(function(e){a({success:e,uid:h})},function(e){s._log("ERROR: "+e),a({error:e,uid:h})})},e.prototype._apply=function(e,n,r){var i,o=t.domain.create(),s=this._defer();return n=n||[],n.push(s.resolve),o.run(function(t){try{i=this[e].apply({ctx:t},n),void 0!==i&&s.resolve(i)}catch(r){s.cancel(r)}}.bind(this,r)),o.on("error",function(e){s.cancel(e)}),s.promise},e.prototype._createFunction=function(e){return this._isServer?this._localFunction.bind(this,e):this._remoteFunction.bind(this,e)},e.prototype._remoteFunction=function(e){var t,n,r=this._defer(),i=Array.prototype.slice.call(arguments,1),o=[];for(n=0;n<i.length;n+=1)t=i[n],o.push("undefined"==typeof t?"\\apibase.undefined\\":null==t?"\\apibase.null\\":t);return o.length||(o="\\apibase.empty\\"),0==this._authState?(this._anonymousLogin(),this._pendingResolutions.push(this._triggerRemote.bind(this,e,o,r))):this._triggerRemote(e,o,r),r.promise},e.prototype._triggerRemote=function(e,n,r){var i=this._ref.child("queue/request").child(e).push();i.setWithPriority({args:n,ctx:this._context,uid:this._user.uid},t.Firebase.ServerValue.TIMESTAMP),this._ref.child("queue/response").child(e).child(i.name()).on("value",function(e){var t=e.val();return t?(t.success&&r.resolve.apply(this,[e.val().success]),t.error&&r.cancel.apply(this,[e.val().error]),e.ref().off(),void e.ref().remove()):!1})},e.prototype._localFunction=function(e){{var t=this._defer(),n=Array.prototype.slice.call(arguments,1);this._context}n.push(t.resolve);var r=function(t){var n=t[t.length-1],r=this[e].apply({ctx:this._context},t);void 0!==r&&n(r)}.bind(this,n);return"undefined"!=typeof process?process.nextTick(r):setTimeout(r,0),t.promise},e.prototype._anonymousLogin=function(){var e=this,t=e._ref.toString().match(/https:\/\/(.+)\.firebaseio.com/)[1],n="https://auth.firebase.com/auth/anonymous?transport=jsonp&firebase="+t;e._authState=1,e._fetch(n).then(function(t){if(t.error)throw"Please enable Anonymous Login on your Firebase. (https://www.firebase.com/docs/security/simple-login-anonymous.html)";e.auth(t.token)})},e.prototype._cleanUp=function(e){this._ref.child("queue/response").child(e).endAt((new Date).valueOf()-this._cleanUpInterval).once("value",function(e){e.numChildren()&&e.forEach(function(e){e.ref().remove()})})},e.prototype._fetch=function(e){var n=this._defer();if(t.request)t.request(e,function(e,t,r){n.resolve(JSON.parse(r))});else{var r=(this._ref.toString().match(/https:\/\/(.+)\.firebaseio.com/)[1],"apibase_"+this._ref.push().name().replace(/-/g,""));window[r]=function(e){n.resolve(e)};var i=document.createElement("script"),o=e+"&callback="+r;i.setAttribute("type","text/javascript"),i.setAttribute("src",o),document.getElementsByTagName("head")[0].appendChild(i)}return n.promise},e.prototype._defer=function(e){var t={};return t._status=0,t.promise={then:function(e,n){t.successCallback=e,t.errorCallback=n,t._status&&t._finish()}},t.resolve=function(){t.args=arguments,t._status=1,t.successCallback&&t._finish()},t.cancel=function(){t.args=arguments,t._status=2,t.errorCallback&&t._finish()},t._finish=function(){1===t._status?t.successCallback.apply(e,t.args):2===t._status&&t.errorCallback.apply(e,t.args)},t},e.prototype._log=function(){("undefined"!=typeof window||"undefined"!=typeof module)&&console.log.apply(this,Array.prototype.slice.call(arguments))},t=this||{},"undefined"!=typeof module&&module.exports)module.exports=function(t){return new e(t)},t.Firebase=require("firebase"),t.domain=require("domain"),t.request=require("request");else{if(t=window,!t.Firebase)throw"Please include Firebase.js";t.APIBase=e}}();